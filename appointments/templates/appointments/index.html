{% extends "appointments/base.html" %}
{% load url_extras %}
{% block content %}
{% if messages %}
{% for message in messages %}
<div class="alert alert-success border-0 shadow-sm" role="alert"
    style="background: linear-gradient(135deg, #d4edda 0%, #e8f5e9 100%); border-left: 5px solid var(--primary-color) !important;">
    <div class="d-flex align-items-center mb-2">
        <i class="bi bi-check-circle-fill me-2" style="color: var(--primary-color); font-size: 1.2rem;"></i>
        <strong>{{ message }}</strong>
    </div>

    {% if request.session.booking_success %}
    <div class="booking-details mt-3 p-3 rounded"
        style="background: rgba(255, 255, 255, 0.7); border: 2px solid var(--accent-color);">
        <div class="row">
            <div class="col-md-8">
                <h6 style="color: var(--rose-gold); margin-bottom: 10px;">
                    <i class="bi bi-calendar-check me-1"></i>Appointment Details:
                </h6>
                <p class="mb-2"><strong>Services:</strong> {{ request.session.booking_success.services|join:", " }}</p>
                <p class="mb-3"><strong>Total:</strong> ${{ request.session.booking_success.total_price }}</p>

                <div class="cancellation-section">
                    <h6 style="color: #e74c3c; margin-bottom: 10px;">
                        <i class="bi bi-exclamation-triangle me-1"></i>Need to Cancel?
                    </h6>
                    {% for cancel_data in request.session.booking_success.cancellation_data %}
                    <div class="mb-2">
                        <span class="me-2"><strong>{{ cancel_data.service_name }}:</strong></span>
                        <a href="{{ cancel_data.url }}" class="btn btn-sm btn-outline-danger"
                            style="border: 2px solid #e74c3c; color: #e74c3c; font-weight: 600; transition: all 0.3s ease;"
                            onmouseover="this.style.background='#e74c3c'; this.style.color='white'"
                            onmouseout="this.style.background='transparent'; this.style.color='#e74c3c'">
                            <i class="bi bi-calendar-x me-1"></i>Cancel This Service
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="col-md-4 text-center">
                <div class="p-3 rounded"
                    style="background: linear-gradient(135deg, var(--accent-color) 0%, #fff5f8 100%);">
                    <i class="bi bi-bookmark-heart" style="font-size: 2rem; color: var(--primary-color);"></i>
                    <p class="mt-2 mb-0" style="color: var(--rose-gold); font-weight: 600; font-size: 0.9rem;">
                        Save this page or screenshot for your records!
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endfor %}
{% endif %}

{% if announcements %}
{% for announcement in announcements %}
<div class="alert alert-secondary" role="alert">
    {{ announcement }}
</div>
{% endfor %}
{% endif %}

<h2>Services</h2>

<div class="row row-cols-1 row-cols-md-3 mb-3 text-center">
    {% for service in services_all %}
    <div class="col">
        <div class="card mb-4 rounded-3 shadow-sm">
            <div class="card-body">
                <h3 class="card-title">{{service.service_name}}</h3>
                <ul class="list-unstyled mt-3 mb-4">
                    <li>{{service.description}}</li>
                    <li>${{service.price}}</li>
                    <li>{{service.duration}} minutes</li>
                </ul>
                <button type="button"
                    class="w-100 btn btn-lg service-select-btn {% if service.service_id == selected_service_id %}btn-primary{% else %}btn-outline-primary{% endif %}"
                    data-service-id="{{service.service_id}}" data-service-name="{{service.service_name}}"
                    data-service-price="{{service.price}}">
                    <span class="select-text">Select</span>
                    <i class="bi bi-check-circle-fill selected-icon d-none"></i>
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
<hr>

{% if hairdressers_all %}
<h2 id="hairdresser">{{ PROVIDER_TITLE_PLURAL }}</h2>
<div class="row row-cols-1 row-cols-md-3 mb-3 text-center">
    {% for hairdresser in hairdressers_all %}
    <div class="col">
        <div
            class="card mb-4 rounded-3 shadow-sm {% if hairdresser.hairdresser_id == selected_hairdresser_id %}border-primary{% endif %}">
            <div class="card-body">
                <h3 class="card-title">{{hairdresser.first_name}} {{hairdresser.last_name}}</h3>
                <i class="bi bi-file-person" style="font-size: 4rem; "></i>
                <a class="w-100 btn btn-lg {% if hairdresser.hairdresser_id == selected_hairdresser_id %}btn-primary{% else %}btn-outline-primary{% endif %}"
                    href="{% if selected_service_ids %}{% relative_url 'index-services-hairdresser' selected_service_ids|join:',' hairdresser.hairdresser_id %}{% else %}{% relative_url 'index-hairdresser' selected_service_id hairdresser.hairdresser_id %}{% endif %}#date">Select</a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
<hr>
{% endif %}


{% if dates_all %}
<h2 id="date">Date</h2>

{% for date in dates_all %}
<a class="btn {% if date.1 == selected_date %}btn-primary{% else %}btn-outline-primary{% endif %}"
    href="{% if selected_service_ids %}{% relative_url 'index-services-date' selected_service_ids|join:',' selected_hairdresser_id date.1 %}{% else %}{% relative_url 'index-date' selected_service_id selected_hairdresser_id date.1 %}{% endif %}#time">
    {{date.0}}
</a>
{% endfor %}

<hr>
{% endif %}


{% if start_times_all %}
<h2 id="time">Time</h2>

{% if selected_services %}
<div class="alert alert-secondary mb-3">
    <h5>Selected Services:</h5>
    <ul class="mb-2">
        {% for service in selected_services %}
        <li>{{ service.service_name }} - ${{ service.price }} ({{ service.duration }} min)</li>
        {% endfor %}
    </ul>
    <strong>Total: ${{ total_price }} | Duration: {{ total_duration }} minutes</strong>
</div>
{% endif %}

<p>{{start_times_available_count}} start times available</p>

<form method="post" action="{% relative_url 'create' %}">
    {% csrf_token %}
    {% if selected_service_ids %}
    <input type="hidden" name="services"
        value="{% for sid in selected_service_ids %}{{ sid }}{% if not forloop.last %},{% endif %}{% endfor %}">
    {% else %}
    <input type="hidden" name="service" value="{{selected_service_id}}">
    {% endif %}
    <input type="hidden" name="hairdresser" value="{{selected_hairdresser_id}}">
    <input type="hidden" name="date" value="{{selected_date}}">

    <div class="mb-3">
        {% for time in start_times_all %}
        <input type="radio" class="btn-check" value="{{time.time_formatted}}" name="appointment_time"
            id="{{time.time_formatted}}" required {% if time.is_blocked %}disabled{% endif %}>
        <label class="btn btn-outline-primary" for="{{time.time_formatted}}">{{time.time_formatted}}</label>
        {% endfor %}
    </div>

    <div class="mb-3">
        <label for="customer_contact" class="form-label">Contact details:</label>
        <div class="input-group">
            <textarea id="customer_contact" name="customer_contact" class="form-control" required></textarea>
        </div>
    </div>

    <input type="submit" class="btn btn-primary btn-confirm" value="Confirm">
</form>
<hr>
{% endif %}


<div id="selected-services" class="mt-4 d-none">
    <div class="card shadow-lg"
        style="background: linear-gradient(135deg, #ffd4e5 0%, #ffe8f0 50%, #fff5f8 100%); border: 3px solid var(--rose-gold);">
        <div class="card-header text-center"
            style="background: linear-gradient(135deg, #d4af37 0%, #f5a3b8 100%); border-bottom: 2px solid var(--rose-gold);">
            <h4 class="mb-0"
                style="color: white; font-family: 'Playfair Display', serif; font-weight: 800; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                <i class="bi bi-check-circle-fill me-2"></i>Selected Services
            </h4>
        </div>
        <div class="card-body">
            <div id="selected-services-list" class="mb-3"></div>
            <hr style="border-color: var(--rose-gold); border-width: 2px;">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"
                    style="color: var(--rose-gold); font-family: 'Playfair Display', serif; font-weight: 700;">
                    Total: $<span id="total-price" style="color: var(--rose-gold);">0.00</span>
                </h5>
                <a href="#hairdresser" class="btn btn-primary btn-lg" id="continue-btn">
                    <i class="bi bi-arrow-right-circle me-2"></i>Continue to Stylists
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedServices = [];

    document.addEventListener('DOMContentLoaded', function () {
        const serviceButtons = document.querySelectorAll('.service-select-btn');
        const selectedServicesDiv = document.getElementById('selected-services');
        const selectedServicesList = document.getElementById('selected-services-list');
        const totalPriceSpan = document.getElementById('total-price');

        serviceButtons.forEach(button => {
            button.addEventListener('click', function () {
                const serviceId = this.dataset.serviceId;
                const serviceName = this.dataset.serviceName;
                const servicePrice = parseFloat(this.dataset.servicePrice);

                const existingIndex = selectedServices.findIndex(s => s.id === serviceId);

                if (existingIndex > -1) {
                    // Remove service
                    selectedServices.splice(existingIndex, 1);
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-outline-primary');
                    this.querySelector('.select-text').textContent = 'Select';
                    this.querySelector('.selected-icon').classList.add('d-none');
                } else {
                    // Add service
                    selectedServices.push({
                        id: serviceId,
                        name: serviceName,
                        price: servicePrice
                    });
                    this.classList.remove('btn-outline-primary');
                    this.classList.add('btn-primary');
                    this.querySelector('.select-text').textContent = 'Selected';
                    this.querySelector('.selected-icon').classList.remove('d-none');
                }

                updateSelectedServicesDisplay();
            });
        });

        function updateSelectedServicesDisplay() {
            if (selectedServices.length === 0) {
                selectedServicesDiv.classList.add('d-none');
                return;
            }

            selectedServicesDiv.classList.remove('d-none');

            let html = '';
            let total = 0;

            selectedServices.forEach(service => {
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded" 
                         style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(245, 163, 184, 0.1) 100%); border: 1px solid var(--rose-gold);">
                        <span style="color: var(--rose-gold); font-weight: 600;">${service.name}</span>
                        <span style="color: var(--rose-gold); font-weight: 700;">$${service.price}</span>
                    </div>
                `;
                total += service.price;
            });

            selectedServicesList.innerHTML = html;
            totalPriceSpan.textContent = total.toFixed(2);

            // Update continue button with selected service IDs
            const continueBtn = document.getElementById('continue-btn');
            const serviceIds = selectedServices.map(s => s.id).join(',');
            continueBtn.href = `{% url 'index-services' 'PLACEHOLDER' %}`.replace('PLACEHOLDER', serviceIds) + '#hairdresser';
        }
    });
</script>

{% endblock %}